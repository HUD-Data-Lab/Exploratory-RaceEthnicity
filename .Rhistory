chronic_categories <- c("Chronically Homeless",
"Not Chronically Homeless",
"Client doesn’t know/Prefers Not to Answer",
"Data not collected")
# ------------------------------------------------------------------------------
# ---------------------- Income Amount Categories ------------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q16
income_amount_categories <- c("No Income", "$1 - $150", "$151 - $250",
"$251 - $500", "$501 - $1,000",
"$1,001 - $1,500", "$1,501 - $2,000",
"$2,001+", "Client.Does.Not.Know.or.Prefers.Not.to.Answer", "Data.Not.Collected")
# ------------------------------------------------------------------------------
# -------------------- Annual Income Amount Categories-------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q16
annual_income_amount_categories <- c(income_amount_categories, "No Annual Required", "Required Annual Missing")
# ------------------------------------------------------------------------------
# ------------------------ Income Type Categories ------------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q18
income_type_categories <- c("Adults with Only Earned Income (i.e., Employment Income)",
"Adults with Only Other Income",
"Adults with Both Earned and Other Income",
"Adults with No Income", "Client.Does.Not.Know.or.Prefers.Not.to.Answer",
"Missing Income Information")
# ------------------------------------------------------------------------------
# ------------------- Annual Income Type Categories ----------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q18
annual_income_type_categories <- c(income_type_categories,
"No Annual Required", "Required Annual Missing")
# ------------------------------------------------------------------------------
# ------------------------------ Gender Columns --------------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER
gender_columns <- c(Woman = "Woman", Man = "Man",
CulturallySpecific = "Culturally Specific Identity",
Transgender = "Transgender", NonBinary = "Non-Binary",
Questioning = "Questioning",
DifferentIdentity = "Different Identity")
# ------------------------------------------------------------------------------
# ----------------------------- Gender List ------------------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q10
# gender_list <- c()
#
# for (gender in names(gender_columns)) {
#   gender_list <- c(gender_list, gender = gender_columns[[gender]])
# }
#
# for (gender in names(gender_columns)) {
#   for (second_gender in names(gender_columns)) {
#     difference <- which(names(gender_columns) == second_gender) -
#       which(names(gender_columns) == gender)
#     if (difference > 0) {
#       test <- paste0(gender, "/", second_gender)
#       gender_list <- c(gender_list,
#                         get(test) =
#                          paste0(
#                            gender_columns[[gender]], "/",
#                            gender_columns[[second_gender]]))
#     }
#   }
# }
gender_list <- names(gender_columns)
gender_name_list <- unname(gender_columns)
possible_gender_combos <- outer(gender_list, gender_list, paste, sep = '/')
possible_gender_name_combos <- outer(gender_name_list, gender_name_list, paste, sep = '/')
for (combo in 1:6) {
gender_list <- c(gender_list, possible_gender_combos[combo, (combo + 1):7])
gender_name_list <- c(gender_name_list, possible_gender_name_combos[combo, (combo + 1):7])
}
report_list_gender <- setNames(gender_name_list, gender_list)
gender_info <- as.data.frame(gender_list)
gender_info$gender_name_list <- gender_name_list
gender_info[ , names(gender_columns)] <- NA
for (col in names(gender_columns)) {
gender_info <- gender_info %>%
mutate(!!col := if_else(str_detect(gender_list, col),
1, 0))
}
# ------------------------------------------------------------------------------
# ------------------------ CSV Benefit Categories -----------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q20a
benefit_list <- c("SNAP", "WIC", "TANFChildCare", "TANFTransportation",
"OtherTANF", "OtherBenefitsSource")
# ------------------------------------------------------------------------------
# ------------------------ CSV Income Categories -----------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q19b
# income_rows_to_show <- c("Earned", "SSI", "SSDI", "VADisabilityService",
#                          "PrivateDisability", "WorkersComp", "TANF",
#                          "SocSecRetirement", "Pension", "ChildSupport",
#                          "Other.Source")
income_rows_to_show <- IncomeTypes$IncomeGroup
# ------------------------------------------------------------------------------
# ------------------------ Outreach Contact Groups -----------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER - Q9
contact_groups <- c("Once", "2-5 times", "6-9 times", "10+ times")
# ------------------------------------------------------------------------------
# ----------------------------- Household Type Groups --------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER -
household_group_list <- c(Total = 0, Without.Children = 0,
With.Children.And.Adults = 0, With.Only.Children = 0,
Unknown.Household.Type = 0)
# ------------------------------------------------------------------------------
# ------------------------- Split Household Type Groups ------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER -
split_household_group_list <- c(Total = 0, Without.Children = 0,
Adults.in.HH.with.Children.and.Adults = 0,
Children.in.HH.with.Children.and.Adults = 0,
With.Only.Children = 0, Unknown.Household.Type = 0)
# ------------------------------------------------------------------------------
# --------------------------- Standard Detail Columns --------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER detail exports
standard_detail_columns <- c("ProjectName", "HouseholdID", "PersonalID",
"EnrollmentID", "RelationshipToHoH",
"EntryDate", "ExitDate", "household_type")
# ------------------------------------------------------------------------------
# ----------------------- Housing Program Detail Columns -----------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER detail exports
housing_program_detail_columns <- c("ProjectName", "HouseholdID",
"PersonalID", "EnrollmentID",
"RelationshipToHoH", "EntryDate",
"HoH_HMID", "MoveInDateAdj",
"ExitDate", "leaver", "household_type")
# ------------------------------------------------------------------------------
# ------------------------- Demographic Detail Columns -------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER detail exports
demographic_detail_columns <- c("age", "age_group", "VeteranStatus",
"household_type", "DisablingCondition",
"chronic")
# ------------------------------------------------------------------------------
# ------------------------ LOT Homeless Detail Columns -------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER detail exports
lot_homeless_detail_columns <- c("LivingSituation", "LengthOfStay",
"LOSUnderThreshold","PreviousStreetESSH",
"DateToStreetESSH", "TimesHomelessPastThreeYears",
"MonthsHomelessPastThreeYears")
# ------------------------------------------------------------------------------
# ------------------------------ CE Detail Columns -----------------------------
# ------------------------------------------------------------------------------
# used in:
#   CE APR detail exports
ce_detail_columns <- c(standard_detail_columns, "AssessmentDate")
# ------------------------------------------------------------------------------
# ------------------------------ Referral Results  -----------------------------
# ------------------------------------------------------------------------------
# used in:
#   CE APR
referral_results <- c("Successful referral: client accepted",
"Unsuccessful referral: client rejected",
"Unsuccessful referral: provider rejected",
"No result recorded")
# ------------------------------------------------------------------------------
# ------------------------------- CSV Columns ----------------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER -
CSV_columns <- read_excel("SupplementalTables.xlsx",
sheet = "CSV_Columns") %>%
mutate(RDataType = case_when(
str_detect(DataType, "S") ~ "c",
DataType == "I" ~ "i",
DataType %in% c("T", "D") ~ DataType,
str_detect(DataType, "M") ~ "d"
)) %>%
select(File, ColumnName, RDataType)
# ------------------------------------------------------------------------------
# -------------------------- Sexual Orientation --------------------------------
# ------------------------------------------------------------------------------
sexual_orientation_columns <- data.frame(
name = c("Heterosexual", "Gay", "Lesbian",
"Bisexual", "Questioning/Unsure",
"Other", "Client Doesn’t Know/Prefers Not to Answer",
"Client Doesn’t Know/Prefers Not to Answer",
"Data not collected"),
value = c(1, 2, 3, 4, 5, 6, 8, 9, 99))
# ------------------------------------------------------------------------------
# -------------------------- Language Supplement -------------------------------
# ------------------------------------------------------------------------------
# used in:
#   APR/CAPER -
possible_languages <- read_excel("HMIS-C4-Translation-Assistance-Needed-Supplement-2024.xlsx",
range = "A1:B328")
possible_languages <- read_excel("HMIS-C4-Translation-Assistance-Needed-Supplement-2024.xlsx",
range = "A1:B328")
youth_education_labels <- read_excel("SupplementalTables.xlsx",
sheet = "YouthEducationStatus")
file_source <- file.choose()
for (file in names(hmis_csvs_fy24)){
data <- read_csv(unzip(file_source, paste0(file, ".csv")),
col_types = get(file, hmis_csvs_fy24))
if (exists(file)) {
data <- get(file) %>%
full_join(data, by = intersect(colnames(get(file)),
colnames(data)))
}
assign(file, data)
file.remove(paste0(file, ".csv"))
}
if(!exists("kit_type")) {
kit_type <- ""
}
if (kit_type == "old_kit") {
relevant_CoC <- "XX-500"
# report_start_date <- ymd(Export[1,]$ExportStartDate)
# report_end_date <- ymd(Export[1,]$ExportEndDate)
report_start_date <- ymd("2020-10-1")
report_end_date <- ymd("2021-9-30")
} else {
relevant_CoC <- "XX-501"
if (exists("lookback_stop_date")) {
report_start_date <- lookback_stop_date
report_end_date <- lookback_stop_date %m+% years(8) %m-% days(1)
} else {
report_start_date <- ymd("2021-10-1")
report_end_date <- ymd("2022-9-30")
}
}
# remove deleted records exportID colummns before proceeding with processing
for (file in names(hmis_csvs_fy24)){
data <- get(file) %>%
distinct()
new_ExportID <- data$ExportID[1]
col_order <- colnames(data)
data <- data %>%
select(-ExportID) %>%
distinct() %>%
mutate(ExportID = new_ExportID) %>%
select(all_of(col_order))
if ("DateDeleted" %in% colnames(get(file))) {
data <- data %>%
filter(is.na(DateDeleted) |
DateDeleted > report_end_date)
}
if (file == "Enrollment") {
data <- data %>%
mutate(MoveInDate = case_when(
MoveInDate <= report_end_date &
MoveInDate >= EntryDate ~ MoveInDate)) %>%
filter(EntryDate <= report_end_date &
EnrollmentID %nin% Exit$EnrollmentID[Exit$ExitDate < report_start_date])
}
if (file == "Exit") {
data <- data %>%
filter(ExitDate >= report_start_date &
ExitDate <= report_end_date)
}
if (file == "Export") {
data$SoftwareName <- "DataLab"
data$SoftwareVersion <- "1.0"
}
assign(file, data)
}
View(data)
report_start_date
report_end_date
sexual_orientation_columns
Race_detail <- Client[,c(1,11:19)]
Race_categories <- Race_detail %>%
mutate(RaceCount = rowSums(across(all_of(unname(race_columns))),na.rm=TRUE)) %>%
group_by(RaceCount) %>%
summarise(n = n())
Race_categories
# Program enrollment and household information from the APR and CAPER PY24 reporting
{
all_program_enrollments <- Enrollment %>%
#filter(ProjectID %in% project_list) %>% # Commented out to include all projects
left_join(Project %>%
select(ProjectID, ProjectType, ProjectName),
by = "ProjectID") %>%
left_join(Exit %>%
select(-PersonalID), # Are we removing personalID to avoid the duplication problem? (i.e., PersonalID.X and PersonalID.Y)
by = "EnrollmentID")
recent_program_enrollment <- all_program_enrollments %>%
group_by(PersonalID) %>%
arrange(desc(EntryDate)) %>% #arrange by most recent entry date
slice(1L) %>% #what does 1L do?
ungroup()
# get additional client information (age for reporting)
client_plus <- add_client_info(recent_program_enrollment)  #View(add_client_info) Getting a warning about mac(age, na.rm=TRUE) is returning -inf
annual_assessment_dates <- Enrollment %>% #What is this trying to get?
group_by(HouseholdID) %>%
mutate(start_for_annual = max(EntryDate[RelationshipToHoH == 1]), #Max entry date for each head of household
years_in_project = trunc((start_for_annual %--% report_end_date) / years(1))) %>% # What does %--% do?
filter(years_in_project > 0) %>%
mutate(annual_due = start_for_annual %m+% years(years_in_project)) %>%
select(HouseholdID, annual_due) %>%
distinct()
household_info <- get_household_info(all_program_enrollments,
return_type = "household")
recent_program_enrollment_r <- recent_program_enrollment %>%
left_join(client_plus, by = "PersonalID") %>%
left_join(household_info, by = "HouseholdID") %>%
mutate(MoveInDateAdj = case_when(
!is.na(HoH_HMID) &
HoH_HMID >= DOB &
HoH_HMID >= EntryDate &
(HoH_HMID <= ExitDate |
is.na(ExitDate)) ~ HoH_HMID,
!is.na(HoH_HMID) &
(HoH_HMID <= ExitDate |
is.na(ExitDate)) ~ EntryDate),
leaver = ExitDate >= report_start_date &
ExitDate <= report_end_date &
!is.na(ExitDate)) %>%
left_join(chronicity_data, by = "EnrollmentID")
}
all_bed_nights <- Services %>%
left_join(Enrollment %>%
filter(ProjectID %in% Project$ProjectID[Project$ProjectType == 1]) %>%
select(EnrollmentID, EntryDate) ,
by = "EnrollmentID") %>%
filter(RecordType == 200 &
TypeProvided == 200 &
DateProvided >= EntryDate &
DateProvided <= report_end_date)
bed_nights_in_report <- all_bed_nights %>%
filter(DateProvided >= report_start_date)
# apply NbN active logic to the enrollment table, since everything is based on that
Enrollment <- Enrollment %>%
filter(ProjectID %nin% Project$ProjectID[Project$ProjectType == 1] |
EnrollmentID %in% Exit$EnrollmentID[Exit$ExitDate >= report_start_date &
Exit$ExitDate <= report_end_date] |
EnrollmentID %in% bed_nights_in_report$EnrollmentID)
disability_table <- Disabilities %>%
filter(DisabilityResponse == 1 |
(DisabilityType == 10 &
DisabilityResponse %in% c(2, 3))) %>%
mutate(disability_name = case_when(DisabilityType == 5 ~ "Physical Disability",
DisabilityType == 6 ~ "Developmental Disability",
DisabilityType == 7 ~ "Chronic Health Condition",
DisabilityType == 8 ~ "HIV/AIDS",
DisabilityType == 9 ~ "Mental Health Disorder",
DisabilityResponse == 1 ~ "Alcohol Use Disorder",
DisabilityResponse == 2 ~ "Drug Use Disorder",
DisabilityResponse == 3 ~ "Both Alcohol and Drug Use Disorders"),
disabilities = if_else(disability_name == "Both Alcohol and Drug Use Disorders", 2, 1),
indefinite_and_impairs = (DisabilityType %in% c(6, 8) |
(DisabilityType %in% c(5, 7, 9, 10) &
IndefiniteAndImpairs == 1))) %>%
select(EnrollmentID, DataCollectionStage, InformationDate, disability_name,
indefinite_and_impairs, disabilities)
additional_disability_check <- disability_table %>%
filter(DataCollectionStage == 1 &
indefinite_and_impairs) %>%
group_by(EnrollmentID) %>%
summarise() %>%
ungroup() %>%
mutate(has_disability = 1)
chronic_individual <- Enrollment %>%
select(EnrollmentID, DisablingCondition, ProjectID, EntryDate,
LivingSituation, LOSUnderThreshold, PreviousStreetESSH,
DateToStreetESSH, TimesHomelessPastThreeYears,
MonthsHomelessPastThreeYears) %>%
left_join(additional_disability_check, by = "EnrollmentID") %>%
filter() %>%
left_join(Project %>%
select(ProjectID, ProjectType),
by = "ProjectID") %>%
mutate(disabling_condition_for_chronic = case_when(
DisablingCondition == 1 |
has_disability == 1 ~ "Y",
DisablingCondition == 0 ~ "N",
DisablingCondition %in% c(8, 9) ~ "Client.Does.Not.Know.or.Prefers.Not.to.Answer",
TRUE ~ "Information.Missing"),
homeless_year_prior = trunc((DateToStreetESSH %--% EntryDate) / years(1)) >= 1 &
!is.na(DateToStreetESSH),
four_or_more_times = case_when(
TimesHomelessPastThreeYears == 4 ~ "Y",
TimesHomelessPastThreeYears %in% c(1, 2, 3) ~ "N",
TimesHomelessPastThreeYears %in% c(8, 9) ~ "Client.Does.Not.Know.or.Prefers.Not.to.Answer",
TRUE ~ "Information.Missing"),
twelve_or_more_months = case_when(
MonthsHomelessPastThreeYears >= 112 ~ "Y",
MonthsHomelessPastThreeYears %in% c(101, 102, 103, 104,
105, 106, 107, 108,
109, 110, 111) ~ "N",
MonthsHomelessPastThreeYears %in% c(8, 9) ~ "Client.Does.Not.Know.or.Prefers.Not.to.Answer",
TRUE ~ "Information.Missing"
),
chronic = case_when(
disabling_condition_for_chronic != "Y" ~ disabling_condition_for_chronic,
is.na(LivingSituation) ~ "Information.Missing",
ProjectType %in% c(0, 1, 4, 8) |
LivingSituation %in% na.omit(ResidenceUses$Location[ResidenceUses$PriorResidenceType_Chronicity == "homeless"]) ~
case_when(
homeless_year_prior ~ "Y",
four_or_more_times != "Y" ~ four_or_more_times,
TRUE ~ twelve_or_more_months
),
LivingSituation %in% na.omit(ResidenceUses$Location[ResidenceUses$PriorResidenceType_Chronicity == "institution"]) ~
case_when(
LOSUnderThreshold == 0 |
DateToStreetESSH == 0 ~ "N",
homeless_year_prior ~ "Y",
four_or_more_times != "Y" ~ four_or_more_times,
TRUE ~ twelve_or_more_months
),
LivingSituation %in% na.omit(ResidenceUses$Location[ResidenceUses$PriorResidenceType_Chronicity == "other"]) ~
case_when(
LOSUnderThreshold == 0 |
DateToStreetESSH == 0 ~ "N",
homeless_year_prior ~ "Y",
four_or_more_times != "Y" ~ four_or_more_times,
TRUE ~ twelve_or_more_months
)
)
) %>%
select(EnrollmentID, chronic)
chronic_household <- Enrollment %>%
select(PersonalID, EnrollmentID, HouseholdID, EntryDate, RelationshipToHoH) %>%
left_join(Client %>%
select(-ExportID),
by = "PersonalID") %>%
mutate(date_for_age = (if_else(
EntryDate <= report_start_date,
report_start_date,
EntryDate)),
age = trunc((DOB %--% date_for_age) / years(1)),
chronic_age_group = case_when(age >= 18 ~ "adult",
age < 18 ~ "child",
TRUE ~ "unknown")) %>%
left_join(chronic_individual %>%
mutate(numeric_chronic = case_when(
chronic == "Y" ~ 1,
chronic == "N" ~ 2,
chronic == "Client.Does.Not.Know.or.Prefers.Not.to.Answer" ~ 3,
chronic == "Information.Missing" ~ 4
)),
by = "EnrollmentID") %>%
group_by(HouseholdID) %>%
mutate(first_entry_date = min(EntryDate),
min_chronicity = min(numeric_chronic),
HoH_chronicity = min(case_when(RelationshipToHoH == 1 ~ numeric_chronic),
na.rm = TRUE),
HoH_or_adult_chronicity = min(case_when(RelationshipToHoH == 1 |
chronic_age_group == "adult" ~ numeric_chronic),
na.rm = TRUE),
new_chronic = factor(
case_when(
min_chronicity == 1 ~ 1,
HoH_or_adult_chronicity %in% c(3, 4) ~ HoH_chronicity,
TRUE ~ numeric_chronic
),
levels = c(1, 2, 3, 4),
labels = c("Y", "N", "Client.Does.Not.Know.or.Prefers.Not.to.Answer", "Information.Missing"))) %>%
ungroup() %>%
filter(EntryDate == first_entry_date) %>%
select(EnrollmentID, new_chronic)
chronicity_data <- chronic_household %>%
full_join(chronic_individual %>%
select(EnrollmentID, chronic),
by = "EnrollmentID") %>%
mutate(chronic = if_else(is.na(new_chronic), chronic, as.character(new_chronic))) %>%
select(-new_chronic)
recent_program_enrollment_r <- recent_program_enrollment %>%
left_join(client_plus, by = "PersonalID") %>%
left_join(household_info, by = "HouseholdID") %>%
mutate(MoveInDateAdj = case_when(
!is.na(HoH_HMID) &
HoH_HMID >= DOB &
HoH_HMID >= EntryDate &
(HoH_HMID <= ExitDate |
is.na(ExitDate)) ~ HoH_HMID,
!is.na(HoH_HMID) &
(HoH_HMID <= ExitDate |
is.na(ExitDate)) ~ EntryDate),
leaver = ExitDate >= report_start_date &
ExitDate <= report_end_date &
!is.na(ExitDate)) #%>%
recent_program_enrollment_r <- recent_program_enrollment %>%
left_join(client_plus, by = "PersonalID") %>%
left_join(household_info, by = "HouseholdID") %>%
mutate(MoveInDateAdj = case_when(
!is.na(HoH_HMID) &
HoH_HMID >= DOB &
HoH_HMID >= EntryDate &
(HoH_HMID <= ExitDate |
is.na(ExitDate)) ~ HoH_HMID,
!is.na(HoH_HMID) &
(HoH_HMID <= ExitDate |
is.na(ExitDate)) ~ EntryDate),
leaver = ExitDate >= report_start_date &
ExitDate <= report_end_date &
!is.na(ExitDate)) %>%
left_join(chronicity_data, by = "EnrollmentID")
